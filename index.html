<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è–èª•è¨Šè™Ÿå°éŠæˆ²</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    /* å¤–å±¤ï¼šæ±ºå®šåœ–ç‰‡ï¼‹åŠåœ“çš„å¯¬åº¦ */
    .wrapper {
      position: relative;
      width: 90vw;
      max-width: 600px;
    }

    /* ä¸Šæ–¹è–èª•åœ–ç‰‡ */
    .main-image {
      width: 100%;
      height: auto;
      display: block;
    }

    /* åŠåœ“æŒ‡é‡ç–Šåœ¨åœ–ç‰‡è£¡ï¼Œé ä¸‹æ–¹ */
    #overlay {
      position: absolute;
      left: 50%;
      bottom: 8%;
      transform: translateX(-50%);
      width: 100%;
      display: flex;
      justify-content: center;
      pointer-events: none;   /* é»æ“Šäº¤çµ¦ window */
    }

    #gameCanvas {
      width: 100%;
      max-width: 600px;
      height: auto;
    }

    /* ä¸‰ç¨®å…¨è¢å¹•é®ç½©ï¼šä¸­çå½±ç‰‡ / æŠ½çå½±ç‰‡ / è¨Šæ¯æ¡† */
    #winOverlay,
    #prizeOverlay,
    #messageOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;              /* é è¨­éš±è— */
      justify-content: center;
      align-items: center;
      z-index: 900;
    }

    #winOverlay video,
    #prizeOverlay video {
      width: 90vw;
      max-width: 480px;
      border-radius: 16px;
    }

    /* è¨Šæ¯æ¡†æ¯”å½±ç‰‡å†é«˜ä¸€å±¤ï¼Œé¿å…è¢«è“‹ä½ */
    #messageOverlay {
      z-index: 1000;
    }

    /* è–èª•æ°›åœæç¤ºæ¡† */
    .message-box {
      position: relative;
      width: 80vw;
      max-width: 420px;
      padding: 24px 20px 26px;
      border-radius: 20px;
      text-align: center;
      background: linear-gradient(135deg, #b71c1c, #880e4f);
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      overflow: hidden;
    }

    .message-box::before,
    .message-box::after {
      content: "";
      position: absolute;
      border-radius: 50%;
      opacity: 0.35;
      pointer-events: none;
    }

    .message-box::before {
      width: 120px;
      height: 120px;
      background: radial-gradient(circle at center, #ffffff, transparent 60%);
      top: -40px;
      left: -30px;
    }

    .message-box::after {
      width: 160px;
      height: 160px;
      background: radial-gradient(circle at center, #ffd54f, transparent 65%);
      bottom: -60px;
      right: -40px;
    }

    .message-title {
      position: relative;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #fff;
      margin-bottom: 8px;
    }

    .message-title span {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.2);
    }

    .message-text {
      position: relative;
      font-size: 16px;
      line-height: 1.6;
      color: #fffbe6;
      margin: 6px 0 20px;
    }

    #callButton {
      position: relative;
      padding: 10px 36px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      background: #ffd54f;
      color: #5a3b00;
      box-shadow: 0 4px 0 #c9a233, 0 0 10px rgba(255, 213, 79, 0.6);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }

    #callButton:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 #b3952c, 0 0 4px rgba(255, 213, 79, 0.6);
    }

    #callButton::before {
      content: "ğŸ“";
      margin-right: 6px;
    }

    /* å¤±æ•—æç¤ºå°æ¡†ï¼šæ”¾åœ¨ wrapper è£¡ã€åŠåœ“ä¸Šæ–¹ï¼Œåº•éƒ¨æœ‰é»ƒè‰²åœ“è§’æ¡† */
    #failToast {
      position: absolute;
      left: 50%;
      bottom: 28%;  /* æ¯”åŠåœ“çš„ bottom:8% å†é«˜ä¸€äº› */
      transform: translateX(-50%) translateY(10px); /* èµ·å§‹ç•¥ä½ä¸€é» */
      padding: 6px 16px 12px;
      background: rgba(0, 0, 0, 0.82);
      border-radius: 999px;
      font-size: 14px;
      letter-spacing: 0.08em;
      color: #fff;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      z-index: 950;  /* æ¯” canvas é«˜ã€æ¯” overlay ä½å°±å¥½ */
      transition: transform 0.6s ease-out, opacity 0.6s ease-out;
    }

    #failToast::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -4px;
      width: 70%;
      height: 6px;
      background: #ffd54f;
      border-radius: 999px;
      box-shadow: 0 0 8px rgba(255, 213, 79, 0.7);
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- èƒŒæ™¯è–èª•æ‰‹æ©Ÿåœ– -->
    <img src="BACKGROUND.png" alt="" class="main-image">

    <div id="overlay">
      <canvas id="gameCanvas" width="600" height="300"></canvas>
    </div>

    <!-- å¤±æ•—æç¤ºå°æ¡†ï¼šæ”¾åœ¨ wrapper è£¡ï¼Œä½ç½®æ‰æœƒè·Ÿè‘—éŠæˆ²èµ° -->
    <div id="failToast"></div>
  </div>

  <!-- ä¸­çæ™‚æ’­æ”¾çš„å‹•ç•«å½±ç‰‡ï¼ˆä¿®å¾©è–èª•è¨Šè™Ÿï¼‰ -->
  <div id="winOverlay">
    <video id="winVideo" playsinline webkit-playsinline>
      <source src="DING.MP4" type="video/mp4">
    </video>
  </div>

  <!-- æŠ½çå½±ç‰‡ï¼ˆæŒ‰ CALL å¾Œæ’­æ”¾ï¼‰ -->
  <div id="prizeOverlay">
    <video id="prizeVideo" playsinline webkit-playsinline>
      <source src="DONG.MP4" type="video/mp4">
    </video>
  </div>

  <!-- è–èª•æç¤ºæ¡† -->
  <div id="messageOverlay">
    <div class="message-box">
      <div class="message-title">
        <span>MERRY XMAS SIGNAL</span>
      </div>
      <div class="message-text">
        å·²æˆåŠŸå¾©åŸè–èª•è¨Šè™Ÿï¼Œæ­£åœ¨èˆ‡åŒ—æ­æœå‹™è™•å–å¾—è¯ç¹«
      </div>
      <button id="callButton">CALL</button>
    </div>
  </div>

  <script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const winOverlay = document.getElementById("winOverlay");
  const winVideo = document.getElementById("winVideo");
  const prizeOverlay = document.getElementById("prizeOverlay");
  const prizeVideo = document.getElementById("prizeVideo");
  const messageOverlay = document.getElementById("messageOverlay");
  const callButton = document.getElementById("callButton");
  const failToast = document.getElementById("failToast");

  let isWinVideoPlaying = false;
  let isMessageShowing = false;
  let isPrizePlaying = false;
  let failToastTimer = null;

  // å¹¾ä¹ä½”æ»¿å¯¬åº¦çš„åŠåœ“
  let cx = canvas.width / 2;
  let cy = canvas.height - 18;
  let outerR = canvas.width * 0.38;
  let innerR = outerR * 0.7;

  const ARC_START = Math.PI;
  const ARC_END   = Math.PI * 2;
  const ARC_LEN   = ARC_END - ARC_START;

  let pointerAngle = ARC_START;
  let pointerDir = 1;
  const pointerSpeed = 3.0;

  let redStart = 0;
  let redEnd = 0;

  let isStopped = false;
  let lastTime = null;

  function resetRound() {
    // å¾ˆå°çš„ä¸­çå€
    const redLen = ARC_LEN * (0.03 + Math.random() * 0.03);
    redStart = ARC_START + Math.random() * (ARC_LEN - redLen);
    redEnd = redStart + redLen;

    pointerAngle = ARC_START;
    pointerDir = 1;
    isStopped = false;
  }

  function drawArc() {
    // ç™½è‰²åŠåœ“èƒŒæ™¯
    ctx.beginPath();
    ctx.arc(cx, cy, outerR, ARC_START, ARC_END, false);
    ctx.arc(cx, cy, innerR, ARC_END, ARC_START, true);
    ctx.closePath();
    ctx.fillStyle = "#ffffff";
    ctx.fill();

    // ç´…è‰²ä¸­çå€ï¼ˆå°æ‰‡å½¢ï¼‰
    ctx.beginPath();
    ctx.arc(cx, cy, outerR, redStart, redEnd, false);
    ctx.arc(cx, cy, innerR, redEnd, redStart, true);  // â˜… é€™è£¡å›åˆ° redStart
    ctx.closePath();
    ctx.fillStyle = "#ff4b4b";
    ctx.fill();
  }

  function drawPointer() {
    const midR = (outerR + innerR) / 2;
    const x = cx + midR * Math.cos(pointerAngle);
    const y = cy + midR * Math.sin(pointerAngle);

    ctx.strokeStyle = "#3ecfff";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(x, y);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(x, y, 8, 0, Math.PI * 2);
    ctx.fillStyle = "#3ecfff";
    ctx.fill();
  }

  function update(dt) {
    if (isStopped) return;

    pointerAngle += pointerDir * pointerSpeed * dt;

    if (pointerAngle > ARC_END) {
      pointerAngle = ARC_END;
      pointerDir = -1;
    } else if (pointerAngle < ARC_START) {
      pointerAngle = ARC_START;
      pointerDir = 1;
    }
  }

  function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawArc();
    drawPointer();
  }

  function loop(timestamp) {
    if (lastTime == null) lastTime = timestamp;
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }

  // ===== å¤±æ•—æç¤ºå°æ¡† =====
  function showFailToast() {
    if (!failToast) return;

    const messages = ["è¨Šè™Ÿå‚³é€å¤±æ•—", "å°±å·®ä¸€é»äº†", "åŠ æ²¹ï¼åŠ æ²¹ï¼"];
    const msg = messages[Math.floor(Math.random() * messages.length)];
    failToast.textContent = msg;

    // æ¸…é™¤ä¸Šä¸€å€‹è¨ˆæ™‚å™¨
    if (failToastTimer) {
      clearTimeout(failToastTimer);
      failToastTimer = null;
    }

    // èµ·å§‹ç‹€æ…‹ï¼šç•¥ä½ã€é€æ˜
    failToast.style.opacity = "0";
    failToast.style.transform = "translateX(-50%) translateY(10px)";

    // å¼·åˆ¶ reflowï¼Œè®“ transition å¾é€™å€‹ç‹€æ…‹é–‹å§‹
    void failToast.offsetWidth;

    // é¡¯ç¤ºï¼šå¾€ä¸Šæ»‘åˆ°åŸä½ä¸¦æ·¡å…¥
    failToast.style.opacity = "1";
    failToast.style.transform = "translateX(-50%) translateY(0)";

    // åœç•™ 1.2 ç§’å¾Œå¾€ä¸Šæ»‘ä¸¦æ·¡å‡º
    failToastTimer = setTimeout(() => {
      failToast.style.opacity = "0";
      failToast.style.transform = "translateX(-50%) translateY(-20px)";
    }, 1200);
  }

  // ===== æµç¨‹æ§åˆ¶ =====

  function showWinVideo() {
    if (!winOverlay || !winVideo) {
      alert("âœ… æ­å–œï¼åœåœ¨ç´…è‰²ç¯„åœå…§ï¼");
      resetRound();
      return;
    }
    isWinVideoPlaying = true;
    winOverlay.style.display = "flex";
    winVideo.currentTime = 0;

    const p = winVideo.play();
    if (p && p.catch) {
      p.catch(() => {
        winVideo.setAttribute("controls", "controls");
      });
    }
  }

  function endWinVideoToMessage() {
    isWinVideoPlaying = false;
    if (winOverlay && winVideo) {
      winOverlay.style.display = "none";
      winVideo.pause();
    }
    showMessageOverlay();
  }

  function showMessageOverlay() {
    isMessageShowing = true;
    if (messageOverlay) messageOverlay.style.display = "flex";
  }

  function hideMessageOverlay() {
    isMessageShowing = false;
    if (messageOverlay) messageOverlay.style.display = "none";
  }

  function showPrizeVideo() {
    if (!prizeOverlay || !prizeVideo) return;
    isPrizePlaying = true;
    prizeOverlay.style.display = "flex";
    prizeVideo.currentTime = 0;

    const p = prizeVideo.play();
    if (p && p.catch) {
      p.catch(() => {
        // è‡ªå‹•æ’­æ”¾è¢«æ“‹ä½æ™‚é¡¯ç¤ºæ§åˆ¶åˆ—ï¼Œè®“ç©å®¶è‡ªå·±æŒ‰æ’­æ”¾
        prizeVideo.setAttribute("controls", "controls");
      });
    }
  }

  function endPrizeVideoAndReset() {
    isPrizePlaying = false;
    if (prizeOverlay && prizeVideo) {
      prizeOverlay.style.display = "none";
      prizeVideo.pause();
    }
    resetRound();
  }

  function handleTap() {
    // æœ‰ä»»ä½• overlay å‡ºç¾æ™‚ä¸è™•ç†éŠæˆ²é»æ“Š
    if (isWinVideoPlaying || isMessageShowing || isPrizePlaying) return;

    if (!isStopped) {
      isStopped = true;
      const hit = pointerAngle >= redStart && pointerAngle <= redEnd;
      if (hit) {
        showWinVideo();
      } else {
        showFailToast();
      }
    } else {
      resetRound();
    }
  }

  // ===== äº‹ä»¶ç¶å®š =====

  window.addEventListener("click", handleTap);
  window.addEventListener("touchstart", (e) => {
    e.preventDefault();
    handleTap();
  }, { passive: false });

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      handleTap();
    }
  });

  // ä¸­çå½±ç‰‡æ’­å®Œæˆ–è¢«é» â†’ é€²å…¥è¨Šæ¯æ¡†
  if (winVideo) {
    winVideo.addEventListener("ended", endWinVideoToMessage);
  }
  if (winOverlay) {
    winOverlay.addEventListener("click", endWinVideoToMessage);
    winOverlay.addEventListener("touchstart", (e) => {
      e.preventDefault();
      endWinVideoToMessage();
    }, { passive: false });
  }

  // æŠ½çå½±ç‰‡éŒ¯èª¤ï¼ˆè·¯å¾‘éŒ¯æˆ–æª”æ¡ˆä¸å­˜åœ¨ï¼‰â†’ æç¤º
  if (prizeVideo) {
    prizeVideo.addEventListener("error", () => {
      alert("æŠ½çå½±ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±èˆ‡è·¯å¾‘ï¼ˆä¾‹å¦‚ DONG.MP4ï¼‰ã€‚");
      endPrizeVideoAndReset();
    });

    prizeVideo.addEventListener("ended", endPrizeVideoAndReset);
  }

  if (prizeOverlay) {
    prizeOverlay.addEventListener("click", endPrizeVideoAndReset);
    prizeOverlay.addEventListener("touchstart", (e) => {
      e.preventDefault();
      endPrizeVideoAndReset();
    }, { passive: false });
  }

  // CALL æŒ‰éˆ•ï¼šé—œé–‰è¨Šæ¯æ¡† â†’ æ’­æŠ½çå½±ç‰‡
  function onCall(e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();  // é˜²æ­¢äº‹ä»¶å†å¾€å¤–å†’æ³¡
    }
    hideMessageOverlay();
    showPrizeVideo();
  }

  if (callButton) {
    callButton.addEventListener("click", onCall);
    callButton.addEventListener("touchstart", onCall, { passive: false });
  }

  resetRound();
  requestAnimationFrame(loop);
  </script>
</body>
</html>
